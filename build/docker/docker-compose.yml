version: "3.0"
services:

  api:
    build:
      context: ./api
    image: "vinyldns/api:${VINYLDNS_VERSION}"
    container_name: "vinyldns-api"
    environment:
      MYSQL_ROOT_PASSWORD: 'pass'
      MYSQL_ROOT_HOST: '%'
    logging:
      driver: none
    ports:
      - "9000:9000"
    volumes:
      - ./api/application.conf:/opt/docker/conf/application.conf
      - ./api/logback.xml:/opt/docker/conf/logback.xml
    depends_on:
      - integration

  ldap:
    container_name: "vinyldns-ldap"
    image: vinyldns/build:openldap
    ports:
      - "19004:19004"

  integration:
    container_name: "vinyldns-api-integration"
    hostname: "vinyldns-integration"
    image: "vinyldns-api-integration"
    build:
      context: ../
      dockerfile: test/api/integration/Dockerfile
    environment:
      RUN_SERVICES: "deps-only tail-logs"
    env_file:
      .env
    ports:
      - "19001-19003:19001-19003/tcp"
      - "19001:19001/udp"

  portal:
    build:
      context: ./portal
    image: "vinyldns/portal:${VINYLDNS_VERSION}"
    container_name: "vinyldns-portal"
    environment:
      MYSQL_ROOT_PASSWORD: 'pass'
      MYSQL_ROOT_HOST: '%'
    logging:
      driver: none
    ports:
      - "9001:9000"
    volumes:
      - ./portal/application.conf:/opt/docker/conf/application.conf
    depends_on:
      - api
      - ldap
